<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FF14 分隊特訓終極套件</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #020617; /* slate-950 */
            color: #e2e8f0;
            font-family: 'Noto Sans TC', sans-serif;
            overflow: hidden;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        .stat-input {
            background-color: #1e293b;
            border: 1px solid #334155;
            color: white;
            padding: 0.25rem;
            border-radius: 0.25rem;
            text-align: center;
            width: 100%;
            font-family: monospace;
            font-size: 0.95rem;
            transition: all 0.2s;
        }
        .stat-input:focus { outline: none; border-color: #6366f1; background-color: #0f172a; }
        
        .selected-card {
            border-color: #818cf8 !important;
            background-color: #1e1b4b !important;
            box-shadow: inset 0 0 0 1px #818cf8;
        }

        .step-connector {
            position: absolute;
            left: 19px;
            top: 36px;
            bottom: -20px;
            width: 2px;
            background-color: #334155;
            z-index: 0;
        }
        .step-item:last-child .step-connector { display: none; }
        
        .badge-step { font-variant-numeric: tabular-nums; }

        /* Tab Styles */
        .tab-btn {
            @apply px-4 py-2 text-sm font-bold text-slate-400 border-b-2 border-transparent transition-all;
        }
        .tab-btn.active {
            @apply text-indigo-400 border-indigo-500 bg-indigo-500/10;
        }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- Header & Tabs -->
    <header class="bg-slate-900 border-b border-slate-800 shrink-0 z-20 shadow-lg">
        <div class="flex justify-between items-center px-4 h-14">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-1.5 rounded-lg shadow-lg shadow-indigo-500/30">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                    </svg>
                </div>
                <div>
                    <h1 class="text-sm font-bold text-white tracking-wide">FF14 分隊特訓終極套件</h1>
                </div>
            </div>
            
            <!-- Tab Navigation -->
            <div class="flex space-x-1 h-full items-end">
                <button onclick="switchTab('team')" id="tab-btn-team" class="tab-btn active">
                    綜合戰略 (隊伍+特訓)
                </button>
                <button onclick="switchTab('solo')" id="tab-btn-solo" class="tab-btn">
                    單獨推演 (純數值)
                </button>
            </div>
        </div>
    </header>

    <!-- CONTENT AREA -->
    <div class="flex-1 relative overflow-hidden">
        
        <!-- TAB 1: TEAM STRATEGY -->
        <div id="view-team" class="absolute inset-0 flex transition-opacity duration-300 min-w-[1024px]">
            
            <!-- 1. Config Pane -->
            <aside class="w-72 bg-slate-900 border-r border-slate-800 flex flex-col shrink-0 overflow-y-auto z-10 custom-scrollbar">
                <div class="p-4 border-b border-slate-800">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider">1. 當前特訓狀態</h2>
                        <span id="t-curr-total" class="text-[10px] px-1.5 py-0.5 rounded bg-slate-800 text-slate-500 border border-slate-700">Total: 280</span>
                    </div>
                    <div class="space-y-2">
                        <div class="flex items-center gap-2"><label class="text-xs text-blue-400 w-8 font-bold">體能</label><input type="number" id="t-curr-phy" class="stat-input" value="80"></div>
                        <div class="flex items-center gap-2"><label class="text-xs text-green-400 w-8 font-bold">心理</label><input type="number" id="t-curr-men" class="stat-input" value="80"></div>
                        <div class="flex items-center gap-2"><label class="text-xs text-amber-400 w-8 font-bold">戰術</label><input type="number" id="t-curr-tac" class="stat-input" value="120"></div>
                    </div>
                </div>
                <div class="p-4 border-b border-slate-800">
                    <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">2. 任務需求</h2>
                    <div class="space-y-2">
                        <div class="flex items-center gap-2"><label class="text-xs text-blue-400 w-8 font-bold">體能</label><input type="number" id="t-miss-phy" class="stat-input" value="315"></div>
                        <div class="flex items-center gap-2"><label class="text-xs text-green-400 w-8 font-bold">心理</label><input type="number" id="t-miss-men" class="stat-input" value="325"></div>
                        <div class="flex items-center gap-2"><label class="text-xs text-amber-400 w-8 font-bold">戰術</label><input type="number" id="t-miss-tac" class="stat-input" value="340"></div>
                    </div>
                </div>
                <div class="p-4 flex-1 flex flex-col min-h-0">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider">3. 隊員名冊</h2>
                        <span class="text-[10px] text-slate-600">勾選必帶</span>
                    </div>
                    <div id="t-roster-list" class="space-y-2 overflow-y-auto pr-1 pb-4 flex-1"></div>
                    <button onclick="calculateTeamStrategy()" class="mt-2 w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded text-sm shadow-lg active:scale-95 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" /></svg>
                        計算最佳方案
                    </button>
                </div>
            </aside>

            <!-- 2. Solutions Pane -->
            <div class="w-80 bg-slate-900/50 border-r border-slate-800 flex flex-col shrink-0 z-0">
                <div class="p-3 border-b border-slate-800 bg-slate-900/80 backdrop-blur shrink-0 flex justify-between items-end">
                    <h2 class="text-sm font-bold text-white">方案列表</h2>
                    <span id="t-combo-count" class="text-[10px] text-slate-500">等待計算</span>
                </div>
                <div id="t-results" class="flex-1 overflow-y-auto p-3 space-y-2">
                    <div class="text-center text-slate-600 py-20 text-xs border-2 border-dashed border-slate-800 rounded-lg">請點擊左側「計算最佳方案」</div>
                </div>
            </div>

            <!-- 3. Plan Pane -->
            <main class="flex-1 bg-slate-950 flex flex-col min-w-0">
                <div class="p-4 border-b border-slate-800 bg-slate-900 shrink-0 flex justify-between items-center">
                    <h2 class="text-sm font-bold text-white flex items-center gap-2">執行步驟詳情</h2>
                </div>
                <div id="t-plan-container" class="flex-1 overflow-y-auto p-8 relative">
                    <div class="absolute inset-0 flex flex-col items-center justify-center text-slate-700 opacity-60 pointer-events-none">
                        <p>請選擇左側方案</p>
                    </div>
                </div>
            </main>
        </div>

        <!-- TAB 2: SOLO SIM -->
        <div id="view-solo" class="absolute inset-0 flex transition-opacity duration-300 opacity-0 pointer-events-none min-w-[800px]">
            
            <!-- 1. Config Pane -->
            <aside class="w-80 bg-slate-900 border-r border-slate-800 flex flex-col shrink-0 overflow-y-auto z-10 shadow-xl p-6 space-y-6">
                <div class="bg-slate-800/50 p-4 rounded-lg border border-slate-700">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-xs font-bold text-blue-400 uppercase tracking-wider">起點 (Start)</h2>
                        <span id="s-curr-total" class="text-[10px] text-slate-500">Total: 280</span>
                    </div>
                    <div class="space-y-3">
                        <div class="flex items-center gap-2"><label class="text-xs text-slate-400 w-8 text-right">體能</label><input type="number" id="s-curr-phy" class="stat-input" value="80"></div>
                        <div class="flex items-center gap-2"><label class="text-xs text-slate-400 w-8 text-right">心理</label><input type="number" id="s-curr-men" class="stat-input" value="80"></div>
                        <div class="flex items-center gap-2"><label class="text-xs text-slate-400 w-8 text-right">戰術</label><input type="number" id="s-curr-tac" class="stat-input" value="120"></div>
                    </div>
                </div>

                <div class="flex justify-center -my-2 opacity-30"><svg class="h-5 w-5 text-slate-400 animate-bounce" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" /></svg></div>

                <div class="bg-slate-800/50 p-4 rounded-lg border border-slate-700">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-xs font-bold text-emerald-400 uppercase tracking-wider">目標 (Target)</h2>
                        <span id="s-target-total" class="text-[10px] text-slate-500">Total: 280</span>
                    </div>
                    <div class="space-y-3">
                        <div class="flex items-center gap-2"><label class="text-xs text-slate-400 w-8 text-right">體能</label><input type="number" id="s-target-phy" class="stat-input" value="80"></div>
                        <div class="flex items-center gap-2"><label class="text-xs text-slate-400 w-8 text-right">心理</label><input type="number" id="s-target-men" class="stat-input" value="120"></div>
                        <div class="flex items-center gap-2"><label class="text-xs text-slate-400 w-8 text-right">戰術</label><input type="number" id="s-target-tac" class="stat-input" value="80"></div>
                    </div>
                </div>

                <button onclick="calculateSoloPath()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 px-4 rounded-lg shadow-lg active:scale-[0.98] flex items-center justify-center gap-2 border border-emerald-500">
                    <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>
                    推演轉換路徑
                </button>
            </aside>

            <!-- 2. Result Pane -->
            <main class="flex-1 bg-slate-950 flex flex-col min-w-0">
                <div class="p-4 border-b border-slate-800 bg-slate-900 shrink-0 flex justify-between items-center shadow-md z-10">
                    <h2 class="text-sm font-bold text-white flex items-center gap-2">推演結果</h2>
                    <div id="s-plan-status" class="text-xs text-slate-400">等待輸入...</div>
                </div>
                <div id="s-plan-container" class="flex-1 overflow-y-auto p-10 relative bg-slate-950">
                    <div id="s-empty-state" class="absolute inset-0 flex flex-col items-center justify-center text-slate-700 opacity-60 pointer-events-none">
                        <p class="text-lg font-light tracking-wide">輸入數值後點擊推演</p>
                    </div>
                    <div id="s-steps-list" class="max-w-2xl mx-auto space-y-0"></div>
                </div>
            </main>
        </div>

    </div>

    <!-- LOGIC -->
    <script>
        // --- CONSTANTS ---
        const HERO_DATAS = {
            '斧術師': [[60,12,24],[61,12,25],[63,12,25],[64,12,26],[65,13,26],[66,13,27],[66,14,28],[68,14,28],[70,14,28],[72,14,28],[73,15,28],[74,15,29],[74,16,30],[75,16,31],[77,16,31],[78,16,32],[79,17,32],[80,17,33],[80,18,34],[82,18,34],[84,18,34],[86,18,34],[87,19,34],[88,19,35],[88,20,36],[89,20,37],[91,20,37],[92,20,38],[93,21,38],[94,21,39],[94,22,40],[96,22,40],[98,22,40],[100,22,40],[101,23,40],[102,23,41],[102,24,42],[103,24,43],[105,24,43],[106,24,44],[107,25,44],[108,25,45],[108,26,46],[110,26,46],[112,26,46],[114,26,46],[115,27,46],[116,27,47],[116,28,48],[117,28,49],[119,28,49],[120,28,50],[121,29,50],[122,29,51],[122,30,52],[124,30,52],[126,30,52],[128,30,52],[129,31,52],[130,31,53]],
            '劍術師': [[48,12,36],[50,12,36],[52,12,36],[54,12,36],[55,13,36],[56,13,37],[56,14,38],[57,14,39],[59,14,39],[60,14,40],[61,15,40],[62,15,41],[62,16,42],[64,16,42],[66,16,42],[68,16,42],[69,17,42],[70,17,43],[70,18,44],[71,18,45],[73,18,45],[74,18,46],[75,19,46],[76,19,47],[76,20,48],[78,20,48],[80,20,48],[82,20,48],[83,21,48],[84,21,49],[84,22,50],[85,22,51],[87,22,51],[88,22,52],[89,23,52],[90,23,53],[90,24,54],[92,24,54],[94,24,54],[96,24,54],[97,25,54],[98,25,55],[98,26,56],[99,26,57],[101,26,57],[102,26,58],[103,27,58],[104,27,59],[104,28,60],[106,28,60],[108,28,60],[110,28,60],[111,29,60],[112,29,61],[112,30,62],[113,30,63],[115,30,63],[116,30,64],[117,31,64],[118,31,65]],
            '弓箭手': [[12,12,72],[13,12,73],[13,12,75],[14,12,76],[14,13,77],[15,13,78],[16,14,78],[17,14,79],[17,14,81],[18,14,82],[18,15,83],[19,15,84],[20,16,84],[21,16,85],[21,16,87],[22,16,88],[22,17,89],[23,17,90],[24,18,90],[25,18,91],[25,18,93],[26,18,94],[26,19,95],[27,19,96],[28,20,96],[29,20,97],[29,20,99],[30,20,100],[30,21,101],[31,21,102],[32,22,102],[33,22,103],[33,22,105],[34,22,106],[34,23,107],[35,23,108],[36,24,108],[37,24,109],[37,24,111],[38,24,112],[38,25,113],[39,25,114],[40,26,114],[41,26,115],[41,26,117],[42,26,118],[42,27,119],[43,27,120],[44,28,120],[45,28,121],[45,28,123],[46,28,124],[46,29,125],[47,29,126],[48,30,126],[49,30,127],[49,30,129],[50,30,130],[50,31,131],[51,31,132]],
            '雙劍師': [[24,12,60],[24,12,62],[24,12,64],[24,12,66],[24,13,67],[25,13,68],[26,14,68],[27,14,69],[27,14,71],[28,14,72],[28,15,73],[29,15,74],[30,16,74],[30,16,76],[30,16,78],[30,16,80],[30,17,81],[31,17,82],[32,18,82],[33,18,83],[33,18,85],[34,18,86],[34,19,87],[35,19,88],[36,20,88],[36,20,90],[36,20,92],[36,20,94],[36,21,95],[37,21,96],[38,22,96],[39,22,97],[39,22,99],[40,22,100],[40,23,101],[41,23,102],[42,24,102],[42,24,104],[42,24,106],[42,24,108],[42,25,109],[43,25,110],[44,26,110],[45,26,111],[45,26,113],[46,26,114],[46,27,115],[47,27,116],[48,28,116],[48,28,118],[48,28,120],[48,28,122],[48,29,123],[49,29,124],[50,30,124],[51,30,125],[51,30,127],[52,30,128],[52,31,129],[53,31,130]],
            '槍術師': [[36,12,48],[37,12,49],[37,12,51],[38,12,52],[38,13,53],[39,13,54],[40,14,54],[40,14,56],[40,14,58],[40,14,60],[40,15,61],[41,15,62],[42,16,62],[43,16,63],[43,16,65],[44,16,66],[44,17,67],[45,17,68],[46,18,68],[46,18,70],[46,18,72],[46,18,74],[46,19,75],[47,19,76],[48,20,76],[49,20,77],[49,20,79],[50,20,80],[50,21,81],[51,21,82],[52,22,82],[52,22,84],[52,22,86],[52,22,88],[52,23,89],[53,23,90],[54,24,90],[55,24,91],[55,24,93],[56,24,94],[56,25,95],[57,25,96],[58,26,96],[58,26,98],[58,26,100],[58,26,102],[58,27,103],[59,27,104],[60,28,104],[61,28,105],[61,28,107],[62,28,108],[62,29,109],[63,29,110],[64,30,110],[64,30,112],[64,30,114],[64,30,116],[64,31,117],[65,31,118]],
            '格鬥家': [[36,24,36],[37,24,37],[37,24,39],[38,24,40],[38,25,41],[39,25,42],[40,26,42],[41,26,43],[41,26,45],[42,26,46],[42,27,47],[43,27,48],[44,28,48],[45,28,49],[45,28,51],[46,28,52],[46,29,53],[47,29,54],[48,30,54],[49,30,55],[49,30,57],[50,30,58],[50,31,59],[51,31,60],[52,32,60],[53,32,61],[53,32,63],[54,32,64],[54,33,65],[55,33,66],[56,34,66],[57,34,67],[57,34,69],[58,34,70],[58,35,71],[59,35,72],[60,36,72],[61,36,73],[61,36,75],[62,36,76],[62,37,77],[63,37,78],[64,38,78],[65,38,79],[65,38,81],[66,38,82],[66,39,83],[67,39,84],[68,40,84],[69,40,85],[69,40,87],[70,40,88],[70,41,89],[71,41,90],[72,42,90],[73,42,91],[73,42,93],[74,42,94],[74,43,95],[75,43,96]],
            '幻術師': [[12,72,12],[12,73,13],[12,75,13],[12,76,14],[13,77,14],[13,78,15],[14,78,16],[14,80,16],[14,82,16],[14,84,16],[15,85,16],[15,86,17],[16,86,18],[16,87,19],[16,89,19],[16,90,20],[17,91,20],[17,92,21],[18,92,22],[18,94,22],[18,96,22],[18,98,22],[19,99,22],[19,100,23],[20,100,24],[20,101,25],[20,103,25],[20,104,26],[21,105,26],[21,106,27],[22,106,28],[22,108,28],[22,110,28],[22,112,28],[23,113,28],[23,114,29],[24,114,30],[24,115,31],[24,117,31],[24,118,32],[25,119,32],[25,120,33],[26,120,34],[26,122,34],[26,124,34],[26,126,34],[27,127,34],[27,128,35],[28,128,36],[28,129,37],[28,131,37],[28,132,38],[29,133,38],[29,134,39],[30,134,40],[30,136,40],[30,138,40],[30,140,40],[31,141,40],[31,142,41]],
            '咒術師': [[12,60,24],[12,61,25],[12,63,25],[12,64,26],[13,65,26],[13,66,27],[14,66,28],[14,67,29],[14,69,29],[14,70,30],[15,71,30],[15,72,31],[16,72,32],[16,73,33],[16,75,33],[16,76,34],[17,77,34],[17,78,35],[18,78,36],[18,79,37],[18,81,37],[18,82,38],[19,83,38],[19,84,39],[20,84,40],[20,85,41],[20,87,41],[20,88,42],[21,89,42],[21,90,43],[22,90,44],[22,91,45],[22,93,45],[22,94,46],[23,95,46],[23,96,47],[24,96,48],[24,97,49],[24,99,49],[24,100,50],[25,101,50],[25,102,51],[26,102,52],[26,103,53],[26,105,53],[26,106,54],[27,107,54],[27,108,55],[28,108,56],[28,109,57],[28,111,57],[28,112,58],[29,113,58],[29,114,59],[30,114,60],[30,115,61],[30,117,61],[30,118,62],[31,119,62],[31,120,63]],
            '秘術師': [[12,48,36],[12,49,37],[12,51,37],[12,52,38],[13,53,38],[13,54,39],[14,54,40],[14,55,41],[14,57,41],[14,58,42],[15,59,42],[15,60,43],[16,60,44],[16,61,45],[16,63,45],[16,64,46],[17,65,46],[17,66,47],[18,66,48],[18,67,49],[18,69,49],[18,70,50],[19,71,50],[19,72,51],[20,72,52],[20,73,53],[20,75,53],[20,76,54],[21,77,54],[21,78,55],[22,78,56],[22,79,57],[22,81,57],[22,82,58],[23,83,58],[23,84,59],[24,84,60],[24,85,61],[24,87,61],[24,88,62],[25,89,62],[25,90,63],[26,90,64],[26,91,65],[26,93,65],[26,94,66],[27,95,66],[27,96,67],[28,96,68],[28,97,69],[28,99,69],[28,100,70],[29,101,70],[29,102,71],[30,102,72],[30,103,73],[30,105,73],[30,106,74],[31,107,74],[31,108,75]],
        };

        const OPERATIONS = [
            { name: "體能特訓", delta: [40, -20, -20], desc: "體+40 / 心-20 / 戰-20" },
            { name: "心理特訓", delta: [-20, 40, -20], desc: "體-20 / 心+40 / 戰-20" },
            { name: "戰術特訓", delta: [-20, -20, 40], desc: "體-20 / 心-20 / 戰+40" },
            { name: "體能與心理", delta: [20, 20, -40], desc: "體+20 / 心+20 / 戰-40" },
            { name: "體能與戰術", delta: [20, -40, 20], desc: "體+20 / 心-40 / 戰+20" },
            { name: "心理與戰術", delta: [-40, 20, 20], desc: "體-40 / 心+20 / 戰+20" }
        ];

        const DEFAULT_ROSTER = [
            { name: '幻術師', level: 43 }, { name: '弓箭手', level: 50 },
            { name: '斧術師', level: 49 }, { name: '幻術師', level: 48 },
            { name: '槍術師', level: 48 }, { name: '秘術師', level: 43 },
            { name: '咒術師', level: 44 }, { name: '劍術師', level: 42 },
        ];

        // --- INIT & TABS ---
        window.onload = function() {
            renderRosterInputs();
            updateTotalDisplay('t-curr', 280);
            updateTotalDisplay('s-curr', 280);
            updateTotalDisplay('s-target', 280);

            // Bind listeners for totals
            ['t-curr', 's-curr', 's-target'].forEach(prefix => {
                ['phy', 'men', 'tac'].forEach(stat => {
                    document.getElementById(`${prefix}-${stat}`).addEventListener('input', () => updateTotalDisplay(prefix));
                });
            });
        };

        function switchTab(tabId) {
            const teamView = document.getElementById('view-team');
            const soloView = document.getElementById('view-solo');
            const btnTeam = document.getElementById('tab-btn-team');
            const btnSolo = document.getElementById('tab-btn-solo');

            if (tabId === 'team') {
                teamView.classList.remove('opacity-0', 'pointer-events-none');
                soloView.classList.add('opacity-0', 'pointer-events-none');
                btnTeam.classList.add('active');
                btnSolo.classList.remove('active');
            } else {
                teamView.classList.add('opacity-0', 'pointer-events-none');
                soloView.classList.remove('opacity-0', 'pointer-events-none');
                btnTeam.classList.remove('active');
                btnSolo.classList.add('active');
            }
        }

        function updateTotalDisplay(prefix) {
            const vals = [
                parseInt(document.getElementById(`${prefix}-phy`).value)||0,
                parseInt(document.getElementById(`${prefix}-men`).value)||0,
                parseInt(document.getElementById(`${prefix}-tac`).value)||0
            ];
            const sum = vals.reduce((a,b)=>a+b,0);
            const el = document.getElementById(`${prefix}-total`);
            el.innerText = `Total: ${sum}`;
            if (sum !== 280 && sum !== 400) {
                el.className = "text-[10px] px-2 py-0.5 rounded bg-red-900/20 text-red-400 border border-red-800 font-bold font-mono";
            } else {
                el.className = "text-[10px] px-2 py-0.5 rounded bg-slate-800 text-slate-500 border border-slate-700 font-mono";
            }
        }

        // --- SHARED UTILS ---
        function getValues(prefix) {
            return [
                parseInt(document.getElementById(`${prefix}-phy`).value)||0,
                parseInt(document.getElementById(`${prefix}-men`).value)||0,
                parseInt(document.getElementById(`${prefix}-tac`).value)||0
            ];
        }

        // --- TAB 1 LOGIC (TEAM) ---
        function renderRosterInputs() {
            const container = document.getElementById('t-roster-list');
            const classes = Object.keys(HERO_DATAS);
            DEFAULT_ROSTER.forEach((member, i) => {
                const div = document.createElement('div');
                div.className = "flex items-center gap-1 bg-slate-800/50 p-1.5 rounded border border-slate-700";
                div.innerHTML = `
                    <div class="text-[10px] text-slate-500 w-3">${i+1}</div>
                    <select class="r-class bg-slate-900 text-white text-[10px] rounded border border-slate-600 w-16 px-1">
                        ${classes.map(c => `<option value="${c}" ${c === member.name ? 'selected' : ''}>${c}</option>`).join('')}
                    </select>
                    <input type="number" class="r-level bg-slate-900 text-white text-[10px] rounded border border-slate-600 w-8 text-center" value="${member.level}" min="1" max="60">
                    <div class="flex-1 text-right"><input type="checkbox" class="r-check accent-indigo-500 w-3 h-3" ${i===2 ? 'checked':''}></div>
                `;
                container.appendChild(div);
            });
        }

        function getRoster() {
            const items = document.querySelectorAll('#t-roster-list > div');
            const roster = [];
            const must = [];
            items.forEach((item, idx) => {
                const cls = item.querySelector('.r-class').value;
                const lvl = parseInt(item.querySelector('.r-level').value);
                const checked = item.querySelector('.r-check').checked;
                roster.push({ idx, cls, lvl, stats: HERO_DATAS[cls][lvl-1] });
                if (checked) must.push(idx);
            });
            return { roster, must };
        }

        function calculateTeamStrategy() {
            const mission = getValues('t-miss');
            const currTrain = getValues('t-curr');
            const { roster, must } = getRoster();
            
            const container = document.getElementById('t-results');
            const countEl = document.getElementById('t-combo-count');
            container.innerHTML = '<div class="text-center text-slate-500 py-4"><div class="animate-spin h-5 w-5 border-2 border-indigo-500 rounded-full border-t-transparent mx-auto mb-2"></div>計算中...</div>';

            setTimeout(() => {
                const solutions = solveCombinations(roster, must, mission, currTrain);
                renderTeamSolutions(solutions);
            }, 50);
        }

        function solveCombinations(roster, must, mission, currTrain) {
            const results = [];
            const indices = [0,1,2,3,4,5,6,7];
            const getCombos = (arr, k) => {
                if(k===0) return [[]];
                if(arr.length===0) return [];
                const first = arr[0];
                const rest = arr.slice(1);
                const withFirst = getCombos(rest, k-1).map(c => [first, ...c]);
                const withoutFirst = getCombos(rest, k);
                return [...withFirst, ...withoutFirst];
            };
            const combos = getCombos(indices, 4);

            combos.forEach(teamIdxs => {
                if (!must.every(m => teamIdxs.includes(m))) return;
                const base = [0,0,0];
                teamIdxs.forEach(idx => {
                    const s = roster[idx].stats;
                    base[0]+=s[0]; base[1]+=s[1]; base[2]+=s[2];
                });
                const reqTrain = [
                    Math.max(0, mission[0] - base[0]),
                    Math.max(0, mission[1] - base[1]),
                    Math.max(0, mission[2] - base[2])
                ];
                const reqSum = reqTrain.reduce((a,b)=>a+b,0);
                if (reqSum <= 280) {
                    const targetTrain = findOptimalTarget(currTrain, reqTrain);
                    const pathResult = runAStarWithPhysics(currTrain, targetTrain);
                    if (pathResult.success) {
                        results.push({ teamIdxs, base, targetTrain, steps: pathResult.path.length, path: pathResult.path });
                    }
                }
            });
            return results.sort((a,b) => a.steps - b.steps);
        }

        function findOptimalTarget(current, required) {
            let surplus = 280 - (required[0] + required[1] + required[2]);
            const target = [...required];
            while (surplus > 0) {
                let bestIdx = 0;
                let minPenalty = Infinity;
                for(let i=0; i<3; i++) {
                    const currDist = Math.abs(current[i] - target[i]);
                    const newDist = Math.abs(current[i] - (target[i] + 1));
                    const penalty = newDist - currDist;
                    if (penalty < minPenalty) { minPenalty = penalty; bestIdx = i; }
                }
                target[bestIdx]++;
                surplus--;
            }
            return target;
        }

        function renderTeamSolutions(solutions) {
            const container = document.getElementById('t-results');
            const countEl = document.getElementById('t-combo-count');
            const planContainer = document.getElementById('t-plan-container');
            
            container.innerHTML = '';
            countEl.innerText = `${solutions.length} 組`;
            planContainer.innerHTML = '<div class="absolute inset-0 flex flex-col items-center justify-center text-slate-700 opacity-60 pointer-events-none"><p>請選擇左側方案</p></div>';

            if (solutions.length === 0) {
                container.innerHTML = '<div class="text-center text-red-400 py-10 text-xs">無法達成任務</div>';
                return;
            }

            const roster = getRoster().roster;
            solutions.slice(0, 50).forEach((sol, i) => {
                const el = document.createElement('div');
                el.className = "bg-slate-800 p-2.5 rounded border border-slate-700 cursor-pointer hover:bg-slate-750 hover:border-indigo-500/50 transition-all group";
                el.onclick = () => {
                    document.querySelectorAll('#t-results > div').forEach(d => d.classList.remove('selected-card'));
                    el.classList.add('selected-card');
                    renderPath(sol.path, sol.targetTrain, 't-plan-container');
                };
                const members = sol.teamIdxs.map(idx => `<span class="text-[10px] bg-slate-900 border border-slate-700 px-1 py-0.5 rounded text-slate-400">${roster[idx].cls}</span>`).join('');
                const stepColor = sol.steps === 0 ? 'text-emerald-400' : sol.steps <= 5 ? 'text-indigo-400' : 'text-amber-400';
                
                el.innerHTML = `
                    <div class="flex justify-between items-center mb-1.5">
                        <div class="font-bold text-white text-xs">方案 #${i+1}</div>
                        <div class="text-[10px] font-bold ${stepColor} bg-slate-900 px-1.5 py-0.5 rounded border border-slate-700 badge-step">${sol.steps} 步</div>
                    </div>
                    <div class="flex flex-wrap gap-1 mb-2">${members}</div>
                    <div class="text-[10px] text-slate-500 font-mono">Target: ${sol.targetTrain.join('/')}</div>
                `;
                container.appendChild(el);
            });
            if (solutions.length > 0) container.firstChild.click();
        }

        // --- TAB 2 LOGIC (SOLO) ---
        function calculateSoloPath() {
            const start = getValues('s-curr');
            const target = getValues('s-target');
            const statusEl = document.getElementById('s-plan-status');
            const emptyEl = document.getElementById('s-empty-state');
            const listEl = document.getElementById('s-steps-list');

            const startSum = start.reduce((a,b)=>a+b,0);
            const targetSum = target.reduce((a,b)=>a+b,0);

            if (startSum !== targetSum) {
                alert('數值總和不匹配，必須相等 (通常為280)');
                return;
            }

            listEl.innerHTML = '';
            emptyEl.classList.add('hidden');
            statusEl.innerText = '計算中...';

            setTimeout(() => {
                const result = runAStarWithPhysics(start, target);
                statusEl.innerHTML = result.success 
                    ? `<span class="text-emerald-400 font-bold">成功 (${result.path.length}步)</span>` 
                    : `<span class="text-amber-400">顯示最接近路徑</span>`;
                renderPath(result.path, target, 's-steps-list');
            }, 50);
        }

        // --- A* & PHYSICS (SHARED) ---
        function runAStarWithPhysics(start, target) {
            const queue = [{ state: start, g: 0, h: heuristic(start, target), path: [] }];
            const visited = new Set();
            const MAX_ITER = 50000;
            let iter = 0;
            let bestNode = queue[0];

            while (queue.length > 0) {
                iter++;
                queue.sort((a,b) => (a.g + a.h) - (b.g + b.h)); 
                const node = queue.shift();

                if (node.h === 0) return { path: node.path, success: true };
                if (node.h < bestNode.h) bestNode = node;
                if (iter > MAX_ITER) return { path: bestNode.path, success: false };

                const key = node.state.join(',');
                if (visited.has(key)) continue;
                visited.add(key);

                for (let op of OPERATIONS) {
                    const nextState = applyPhysics(node.state, op);
                    if (!nextState) continue;
                    if (node.g > 20) continue; 
                    const h = heuristic(nextState, target);
                    queue.push({ state: nextState, g: node.g + 1, h: h, path: [...node.path, { op, res: nextState }] });
                }
            }
            return { path: bestNode.path, success: false };
        }

        function heuristic(a, b) {
            return Math.abs(a[0]-b[0]) + Math.abs(a[1]-b[1]) + Math.abs(a[2]-b[2]);
        }

        function applyPhysics(prev, op) {
            let next = [...prev];
            let gainIdx = op.delta.findIndex(x => x > 0);
            let drainIndices = [0,1,2].filter(i => i !== gainIdx);
            
            let requiredGain = 40;
            if (op.delta[gainIdx] === 20) requiredGain = 20;

            if (op.name.includes('與')) {
                let loseIdx = op.delta.findIndex(x => x === -40);
                let gainIndices = [0,1,2].filter(i => i !== loseIdx);
                let actualLoss = 40;
                if (next[loseIdx] < 40) actualLoss = next[loseIdx];
                next[loseIdx] -= actualLoss;
                let totalGain = actualLoss;
                let half = Math.floor(totalGain / 2);
                next[gainIndices[0]] += half;
                next[gainIndices[1]] += (totalGain - half);
            } else {
                let d1 = drainIndices[0];
                let d2 = drainIndices[1];
                let loss1 = 20, loss2 = 20;
                if (next[d1] < 20) {
                    let actual = next[d1];
                    loss1 = actual;
                    loss2 += (20 - actual);
                }
                if (next[d2] < loss2) {
                    let actual = next[d2];
                    loss2 = actual;
                    requiredGain = loss1 + loss2;
                }
                next[d1] -= loss1;
                next[d2] -= loss2;
                next[gainIdx] += requiredGain;
            }
            return next;
        }

        // --- RENDER PATH (SHARED) ---
        function renderPath(path, target, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            if (path.length === 0) {
                container.innerHTML = '<div class="p-4 bg-slate-800 border border-slate-700 rounded text-center text-slate-400">無需特訓</div>';
                return;
            }

            let prevStats = null; // Start state depends on context, inferred from first step delta? No, need accurate highlight.
            // Simplified rendering: just render steps. Highlight zero transfer if obvious.
            
            path.forEach((step, i) => {
                const el = document.createElement('div');
                el.className = "step-item relative pl-10 pb-6 group";
                // Detect physics: We don't have prev state easily passed here for generic render without context
                // But we can check standard delta
                const isTransfer = !step.op.name.includes('與') && (
                    (step.op.name.includes('體') && step.op.delta[0] === 40 && step.res[0] % 20 !== 0) || // Crude heuristic
                    false // Actually hard to detect without prev state history. Let's just render clean.
                ); 
                
                el.innerHTML = `
                    <div class="step-connector"></div>
                    <div class="absolute left-0 top-0 w-10 h-10 rounded-full bg-slate-800 border-2 border-emerald-500 text-white font-bold flex items-center justify-center text-lg z-10 shadow-lg shadow-emerald-900/20">
                        ${i + 1}
                    </div>
                    <div class="bg-slate-800 p-3 rounded-lg border border-slate-700 shadow-sm group-hover:border-indigo-500/50 transition-colors">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-white text-sm">${step.op.name}</h3>
                            <span class="text-[10px] text-slate-500 font-mono bg-slate-900 px-1.5 py-0.5 rounded">${step.res.join('/')}</span>
                        </div>
                        <div class="text-[10px] text-slate-400">${step.op.desc}</div>
                    </div>
                `;
                container.appendChild(el);
            });

            container.insertAdjacentHTML('beforeend', `
                <div class="step-item relative pl-10 pt-2">
                    <div class="absolute left-3 top-0 w-4 h-4 rounded-full bg-emerald-500 shadow-lg shadow-emerald-500/50"></div>
                    <div class="text-sm text-emerald-400 font-bold pt-0.5">達成目標 ${target.join('/')}</div>
                </div>
            `);
        }
    </script>
</body>
</html>
